<!DOCTYPE html>
<html>
<head>
    <title>Index</title>
    <script src="Scripts/jquery-1.8.0.js" type="text/javascript"></script>
    <script src="Scripts/jquery.signalR-0.5.3.js" type="text/javascript"></script>
    <script src="signalr/hubs" type="text/javascript"></script>
    <script src="Scripts/bootstrap.js"></script>
    <link href="Content/css/bootstrap.css" rel="stylesheet" />
    <link href="Content/css/custom.css" rel="stylesheet" />
</head>
<body>
    <script type="text/javascript">

        function addSite(url) {
            if ($('.site[data-url="' + url + '"]').length == 0) {
                $('<tr class="site" data-url="' + url + '">'
                    + '<td>' + url + '</td>'
                    + '<td><button class="statusButton btn btn-warning" data-url="' + url + '">Waiting</button></td>'
                    + '<td><a class="btn btn-small removeSite" href="#" data-url="' + url + '"><i class="icon-remove"></i></a></td>'
                    + '</tr>')
                    .hide()
                    .appendTo('#sites')
                    .fadeIn('fast');
            }
        }

        function updateSiteStatus(url, status) {
            var statusLbl = 'Up';
            var cssClass = 'btn-success';

            if (status == false) {
                statusLbl = 'Down';
                cssClass = 'btn-danger';
            }
            else if (status == 'btn-warning') {
                statusLbl = 'Waiting';
                cssClass = status;
            }
            else if (status == 'btn-info') {
                statusLbl = 'Checking';
                cssClass = status;
            }

            $('.statusButton[data-url="' + url + '"]').removeClass('btn-danger');
            $('.statusButton[data-url="' + url + '"]').removeClass('btn-success');
            $('.statusButton[data-url="' + url + '"]').removeClass('btn-warning');
            $('.statusButton[data-url="' + url + '"]').removeClass('btn-info');

            $('.statusButton[data-url="' + url + '"]').addClass(cssClass);
            $('.statusButton[data-url="' + url + '"]').text(statusLbl);
        }

        $(function () {
            var connection = $.hubConnection();
            connection.logging = true;

            var hub = connection.createProxy('siteMonitor');

            hub
                .on('notifySiteStatus', function (monitorUpdate) {
                    updateSiteStatus(monitorUpdate.Url, monitorUpdate.Result);
                })
                .on('notifySiteRemoved', function (url) {
                    $('.site[data-url="' + url + '"]').fadeOut('fast', function () {
                        $('.site[data-url="' + url + '"]').remove();
                    });
                    hub.invoke('getSiteList');
                })
                .on('notifySiteAdded', function (url) {
                    hub.invoke('getSiteList');
                })
                .on('checkingSite', function (url) {
                    updateSiteStatus(url, 'btn-info');
                })
                .on('sitesObtained', function (sites) {
                    $(sites).each(function (i, site) {
                        addSite(site);
                    });
                });

            $('#addSite').click(function () {
                hub.invoke('addSite', $('#siteUrl').val());
            });

            $('.removeSite').live('click', function () {
                hub.invoke('removeSite', $(this).data('url'));
            });

            connection.start().done(function () {
                hub.invoke('getSiteList');
            });
        });

    </script>

    <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="navbar-inner">
            <div class="container-fluid">
                <a class="brand" href="#">Site Monitor</a>
                <div class="nav-collapse collapse">
                    <ul class="nav">
                        <li class="active"><a href="/Default.html">Home</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row-fluid">
            <div class="span12 addSiteForm">
                <label for="siteUrl">Site URL</label>
                <input type="text" id="siteUrl" name="siteUrl" />
                <p>
                    <button class="btn btn-primary btn-large" id="addSite">Add Site</button>
                </p>
            </div>
        </div>
        <table class="table" id="sites">
            <tr>
                <th>URL</th>
                <th></th>
                <th></th>
            </tr>
        </table>
    </div>

    <footer>
        <p>&copy; Company 2012</p>
    </footer>
</body>
</html>
